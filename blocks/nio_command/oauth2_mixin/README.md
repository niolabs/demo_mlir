# OAuth2 Mixin

A collection of block mixins to enable OAuth 2.0 support in your blocks.

Here are the currently supported mixin classes:
 * [OAuth2ServiceAccount](#oauth2serviceaccount)
 * [OAuth2PasswordGrant](#oauth2passwordgrant)

## Usage

To make use of this mixin, select the class representing the OAuth workflow you want to represent and have your block inherit from that class.

#### Example

This block supports obtaining access tokens via the OAuth 2.0 Password Grant Type now.

```python
class SampleOAuthBlock(OAuth2PasswordGrant, Block)
    pass
```

### Setting the OAuth URL

Your block will likely want to define where the OAuth URLs are located. To do so, override the `get_oauth_base_url` method in your block and return a string with the URL. Make sure to include the trailing slash.

#### Example
```python
class SampleOAuthBlock(OAuth2PasswordGrant, Block)
    
    def get_oauth_base_url(self):
        return 'https://my.api.com/oauth2/'
```
    

### Obtaining the access token

In your block code, you can call the `get_access_token` method which will return and save the token, or will raise an `OAuth2Exception` in the case of failure. The argument signature of the method will depend on which type of OAuth workflow you select, but the method will always be called `get_access_token`.

The token will be saved on the class as `self._oauth_token` and will contain any and all information returned by the OAuth request. This often includes the token as well as expiry time and a refresh token.

### Using the access token

Most uses of OAuth require setting an `Authentication` header on a request. The mixin provides a method called `get_access_token_headers` for this purpose. It will return a dictionary containing the authentication header.

#### Example
```python
>>> self.get_access_token_headers()
{"Authentication": "Bearer asdf.tokentext.asdf"}

# This request changes the type of authentication for the header and also specifies
# a different location to find the token value. 
>>> self.get_access_token_headers(bearer_text='CustomType', key='token_field')
{"Authentication": "CustomType asdf.tokentext.asdf"}
```

The `key` argument represents the key on the dictionary returned by the token request to find the actual token.
`key` defaults to `"access_token"` which is consitent with the [OAuth spec](https://tools.ietf.org/html/rfc6749#section-4.1.4).

### OAuth2ServiceAccount

Support Google Service Accounts.

#### Block Parameters

 * **Private Key Config File** (*key_config_file*) - This should be set to a file location (relative to the project or an absolute path) where the private key information can be found. The file should follow the format of the file generated by clicking "Download JSON" from the Google Developers Console.
 
#### Getting the access token

The `get_access_token` method loads the private key JSON file and, using the private key, creates credentials that are sent to the token endpoint. You can specify an optional scope for the request.

#### Examples
```python
# Get an access token with no scope
>>> self.get_access_token()
{ "access_token":"2YotnFZFEjr1zCsicMWpAA", "token_type":"example" ...

# Get an access token with scope "email"
>>> self.get_access_token(scope="email")
{ "access_token":"2YotnFZFEjr1zCsicMWpAA", "token_type":"example" ...

# Get an access token by hitting a custom endpoint (the default endpoint is "token").
# This example's request will go to https://my.api.com/oauth2/service_token
>>> self.get_access_token(token_endpoint="service_token")
{ "access_token":"2YotnFZFEjr1zCsicMWpAA", "token_type":"example" ...
```

### OAuth2PasswordGrant

Support the [Password Credentials Grant](https://tools.ietf.org/html/rfc6749#section-4.3)

#### Block Parameters

 * None
 
#### Getting the access token

The `get_access_token` method takes a username and password and retrieves a token. You can specify an optional scope for the request, additional parameters to send in the request, and a custom grant type.

#### Examples
```python
# Get an access token with no scope
>>> self.get_access_token(username="user", password="pass")
{ "access_token":"2YotnFZFEjr1zCsicMWpAA", "token_type":"example" ...

# Get an access token with scope "email"
>>> self.get_access_token(username="user", password="pass", scope="email")
{ "access_token":"2YotnFZFEjr1zCsicMWpAA", "token_type":"example" ...

# Get an access token by hitting a custom endpoint (the default endpoint is "token").
# This example's request will go to https://my.api.com/oauth2/password_token
>>> self.get_access_token(username="user", password="pass", token_endpoint="password_token")
{ "access_token":"2YotnFZFEjr1zCsicMWpAA", "token_type":"example" ...

# Get an access token with a grant_type of "password" (note - this is the default)
>>> self.get_access_token(username="user", password="pass", grant_type="password")
{ "access_token":"2YotnFZFEjr1zCsicMWpAA", "token_type":"example" ...
```
